<div class="page-container claim-detail" *ngIf="claim">
  <!-- Page header -->
  <header class="page-header" *ngIf="!isPrintMode">
    <div class="header-left">
      <button class="back-btn" routerLink="/dashboard-employee/claims">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      <h2>Claim #{{ claim.metadata.claimId }}</h2>
    </div>
    <span
      class="status-chip {{ claim.status.replace(' ', '-').toLowerCase() }}"
    >
      {{ claim.status }}
    </span>
  </header>

  <!-- Rejection reason -->
  <div
    *ngIf="claim.status === 'Rejected' && claim.payerResponse"
    class="rejection-reason"
  >
    <strong>Reason for Rejection:</strong>
    {{ claim.payerResponse.reasonDescription || "Not provided" }}
  </div>

  <!-- Two-column grid -->
  <div class="form-grid">
    <!-- Patient -->
    <section class="form-section">
      <h3>Patient</h3>
      <p><strong>MRN</strong> {{ claim.patient.mrn }}</p>
      <p>
        <strong>Name</strong> {{ claim.patient.firstName }}
        {{ claim.patient.lastName }}
      </p>
      <p><strong>DOB</strong> {{ claim.patient.dob | date }}</p>
      <p><strong>Gender</strong> {{ claim.patient.gender || "—" }}</p>
      <p *ngIf="claim.patient.phone">
        <strong>Phone</strong> {{ claim.patient.phone }}
      </p>
      <p *ngIf="claim.patient.email">
        <strong>Email</strong> {{ claim.patient.email }}
      </p>
      <p *ngIf="claim.patient.addressLine1">
        <strong>Address</strong> {{ claim.patient.addressLine1 }}
        {{ claim.patient.addressLine2 }} {{ claim.patient.city }},
        {{ claim.patient.state }} {{ claim.patient.zip }}
      </p>
    </section>

    <!-- Provider -->
    <section class="form-section">
      <h3>Provider</h3>
      <p>
        <strong>Rendering</strong>
        {{ claim.provider.renderingProviderName }} (NPI
        {{ claim.provider.renderingNPI }})
      </p>
      <p *ngIf="claim.provider.billingProviderName">
        <strong>Billing</strong> {{ claim.provider.billingProviderName }} (NPI
        {{ claim.provider.billingNPI }})
      </p>
      <p *ngIf="claim.provider.facilityName">
        <strong>Facility</strong> {{ claim.provider.facilityName }} (NPI
        {{ claim.provider.facilityNPI }})
      </p>
      <p *ngIf="claim.provider.facilityAddress">
        <strong>Facility Address</strong> {{ claim.provider.facilityAddress }}
      </p>
      <p *ngIf="claim.provider.taxonomyCode">
        <strong>Taxonomy</strong> {{ claim.provider.taxonomyCode }}
      </p>
      <p *ngIf="claim.provider.specialtyCode">
        <strong>Specialty</strong> {{ claim.provider.specialtyCode }}
      </p>
      <p *ngIf="claim.provider.referringProviderName">
        <strong>Referring</strong>
        {{ claim.provider.referringProviderName }} (NPI
        {{ claim.provider.referringNPI }})
      </p>
    </section>

    <!-- Insurance -->
    <section class="form-section">
      <h3>Insurance</h3>
      <ng-container *ngIf="!editMode; else insuranceEdit">
        <p><strong>Payer</strong> {{ claim.insurance.payerName }}</p>
        <p><strong>Policy #</strong> {{ claim.insurance.policyNumber }}</p>
        <p *ngIf="claim.insurance.groupNumber">
          <strong>Group #</strong> {{ claim.insurance.groupNumber }}
        </p>
        <p *ngIf="claim.insurance.subscriberName">
          <strong>Subscriber</strong> {{ claim.insurance.subscriberName }}
        </p>
        <p *ngIf="claim.insurance.relationshipToSubscriber">
          <strong>Relationship</strong>
          {{ claim.insurance.relationshipToSubscriber }}
        </p>
      </ng-container>
      <ng-template #insuranceEdit>
        <ng-container *ngIf="workingCopy as wc">
          <div class="form-row">
            <label>Payer</label><input [(ngModel)]="wc.insurance.payerName" />
          </div>
          <div class="form-row">
            <label>Policy #</label
            ><input [(ngModel)]="wc.insurance.policyNumber" />
          </div>
          <div class="form-row">
            <label>Group #</label
            ><input [(ngModel)]="wc.insurance.groupNumber" />
          </div>
          <div class="form-row">
            <label>Subscriber</label
            ><input [(ngModel)]="wc.insurance.subscriberName" />
          </div>
          <div class="form-row">
            <label>Relationship</label
            ><input [(ngModel)]="wc.insurance.relationshipToSubscriber" />
          </div>
        </ng-container>
      </ng-template>
    </section>

    <!-- Encounter -->
    <section class="form-section">
      <h3>Encounter</h3>
      <p><strong>Date of Service</strong> {{ claim.dateOfService | date }}</p>
      <p>
        <strong>Submitted</strong>
        {{ claim.metadata.submittedAt | date : "short" }}
      </p>
      <p>
        <strong>Last Updated</strong>
        {{ claim.metadata.lastUpdatedAt | date : "short" }}
      </p>
      <p><strong>Submitted By</strong> {{ claim.metadata.submittedBy }}</p>
      <p *ngIf="claim.metadata.priorAuthNumber">
        <strong>Prior Auth #</strong> {{ claim.metadata.priorAuthNumber }}
      </p>
      <p *ngIf="claim.metadata.referralNumber">
        <strong>Referral #</strong> {{ claim.metadata.referralNumber }}
      </p>
    </section>
  </div>

  <!-- Secondary Insurance -->
  <section *ngIf="claim.secondaryInsurance" class="form-section">
    <h3>Secondary Insurance</h3>
    <p><strong>Payer</strong> {{ claim.secondaryInsurance!.payerName }}</p>
    <p>
      <strong>Policy #</strong> {{ claim.secondaryInsurance!.policyNumber }}
    </p>
    <p *ngIf="claim.secondaryInsurance!.subscriberName">
      <strong>Subscriber</strong> {{ claim.secondaryInsurance!.subscriberName }}
    </p>
    <p *ngIf="claim.secondaryInsurance!.relationshipToSubscriber">
      <strong>Relationship</strong>
      {{ claim.secondaryInsurance!.relationshipToSubscriber }}
    </p>
    <p
      *ngIf="claim.coordinationOfBenefits && claim.coordinationOfBenefits.notes"
    >
      <strong>COB Notes</strong> {{ claim.coordinationOfBenefits.notes }}
    </p>
  </section>

  <!-- Diagnoses -->
  <section class="form-section">
    <h3>Diagnoses</h3>
    <ng-container *ngIf="!editMode; else diagnosesEdit">
      <div class="chips">
        <span *ngFor="let dx of claim.diagnoses; index as i" class="chip">
          {{ pointerLabels[i] }}: {{ dx.code
          }}{{ dx.primary ? " (Primary)" : "" }}
        </span>
      </div>
    </ng-container>
    <ng-template #diagnosesEdit>
      <ng-container *ngIf="workingCopy as wc">
        <div class="diagnoses-list">
          <div
            class="diagnosis-row"
            *ngFor="let dx of wc.diagnoses; index as i"
          >
            <input type="text" [(ngModel)]="dx.code" placeholder="ICD-10" />
            <input
              type="text"
              [(ngModel)]="dx.description"
              placeholder="Description"
            />
            <div class="primary-radio">
              <input
                type="radio"
                name="primaryDx"
                [checked]="dx.primary"
                (change)="setPrimaryDiagnosis(i)"
              />
              <label>Primary</label>
            </div>
            <button class="icon-btn danger" (click)="removeDiagnosis(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <button class="icon-btn" (click)="addDiagnosis()">
            <mat-icon>add</mat-icon> Add diagnosis
          </button>
        </div>
      </ng-container>
    </ng-template>
  </section>

  <!-- Service Lines -->
  <section class="form-section">
    <h3>Service Lines</h3>
    <ng-container *ngIf="!editMode; else serviceLinesEdit">
      <ul class="service-lines">
        <li *ngFor="let sl of claim.serviceLines; index as i">
          <span class="chip">{{ sl.cptCode }}</span>
          <span *ngIf="sl.modifier1"
            >Mod: {{ sl.modifier1 }} {{ sl.modifier2 }} {{ sl.modifier3 }}
            {{ sl.modifier4 }}</span
          >
          <span>Units: {{ sl.units }}</span>
          <span>Charge: ${{ sl.chargeAmount }}</span>
          <span *ngIf="sl.placeOfService">POS: {{ sl.placeOfService }}</span>
          <span *ngIf="sl.ndcCode">NDC: {{ sl.ndcCode }}</span>
          <span *ngIf="sl.diagnosisPointers && sl.diagnosisPointers.length"
            >Dx Ptrs: {{ sl.diagnosisPointers.join(", ") }}</span
          >
        </li>
      </ul>
    </ng-container>
    <ng-template #serviceLinesEdit>
      <ng-container *ngIf="workingCopy as wc">
        <div class="service-lines-edit">
          <div class="grid-4 header">
            <span><strong>CPT</strong></span>
            <span><strong>Units</strong></span>
            <span><strong>Charge</strong></span>
            <span><strong>POS</strong></span>
            <span><strong>Actions</strong></span>
          </div>

          <div
            class="grid-4 row"
            *ngFor="let sl of wc.serviceLines; index as i"
          >
            <input [(ngModel)]="sl.cptCode" placeholder="CPT/HCPCS" />
            <input
              type="number"
              [(ngModel)]="sl.units"
              (change)="recalcFinancials()"
            />
            <input
              type="number"
              [(ngModel)]="sl.chargeAmount"
              (input)="recalcFinancials()"
            />
            <input [(ngModel)]="sl.placeOfService" placeholder="POS" />

            <button class="icon-btn danger" (click)="removeServiceLine(i)">
              <mat-icon>delete</mat-icon>
            </button>

            <!-- Modifiers -->
            <div class="form-row" style="grid-column: 1 / span 5">
              <label>Modifiers</label>
              <input [(ngModel)]="sl.modifier1" placeholder="Mod1" />
              <input [(ngModel)]="sl.modifier2" placeholder="Mod2" />
              <input [(ngModel)]="sl.modifier3" placeholder="Mod3" />
              <input [(ngModel)]="sl.modifier4" placeholder="Mod4" />
            </div>

            <!-- Diagnosis pointers -->
            <div class="form-row" style="grid-column: 1 / span 5">
              <label>Dx Pointers</label>
              <div class="chips">
                <span
                  *ngFor="let label of pointerLabels"
                  class="chip"
                  [class.selected]="sl.diagnosisPointers.includes(label)"
                  (click)="toggleDiagnosisPointer(i, label)"
                >
                  {{ label }}
                </span>
              </div>
            </div>

            <!-- NDC code -->
            <div class="form-row" style="grid-column: 1 / span 5">
              <label>NDC</label>
              <input
                [(ngModel)]="sl.ndcCode"
                placeholder="NDC Code (for drugs)"
              />
            </div>
          </div>

          <button class="icon-btn" (click)="addServiceLine()">
            <mat-icon>add</mat-icon> Add line
          </button>
        </div>
      </ng-container>
    </ng-template>
  </section>

  <!-- Financials -->
  <section class="form-section">
    <h3>Financials</h3>
    <ul class="financials">
      <li>
        <strong>Total Charge</strong> ${{
          editMode && workingCopy
            ? workingCopy.financials.totalCharge
            : claim.financials.totalCharge
        }}
      </li>
      <li *ngIf="claim.financials.allowedAmount">
        <strong>Allowed</strong> ${{ claim.financials.allowedAmount }}
      </li>
      <li *ngIf="claim.financials.paidAmount">
        <strong>Paid</strong> ${{ claim.financials.paidAmount }}
      </li>
      <li *ngIf="claim.financials.patientResponsibility">
        <strong>Patient Resp.</strong> ${{
          claim.financials.patientResponsibility
        }}
      </li>
      <li>
        <strong>Balance</strong> ${{
          editMode && workingCopy
            ? workingCopy.financials.balance
            : claim.financials.balance
        }}
      </li>
    </ul>
  </section>

  <!-- Payer Response -->
  <section *ngIf="claim.payerResponse" class="form-section">
    <h3>Payer Response</h3>
    <p><strong>Status</strong> {{ claim.payerResponse!.status || "—" }}</p>
    <p *ngIf="claim.payerResponse!.reasonCode">
      <strong>Reason</strong> {{ claim.payerResponse!.reasonCode }} —
      {{ claim.payerResponse!.reasonDescription }}
    </p>
    <p *ngIf="claim.payerResponse!.notes">
      <strong>Notes</strong> {{ claim.payerResponse!.notes }}
    </p>
  </section>

  <!-- Attachments -->
  <section
    *ngIf="claim.attachments && claim.attachments.length"
    class="form-section"
  >
    <h3>Attachments</h3>
    <ul class="attachments">
      <li *ngFor="let a of claim.attachments">
        <span class="chip">{{ a.type }}</span>
        <span class="file">{{ a.filename }}</span>
        <span class="meta"
          >uploaded {{ a.uploadedAt | date : "short" }} by
          {{ a.uploadedBy }}</span
        >
      </li>
    </ul>
  </section>

  <!-- History -->
  <section
    *ngIf="claim.auditTrail && claim.auditTrail.length"
    class="form-section"
  >
    <h3>History (Recent)</h3>
    <ul class="history">
      <li *ngFor="let ev of claim.auditTrail">
        <span class="meta">{{ ev.at | date : "short" }}</span>
        <span class="chip">{{ ev.action }}</span>
        <span class="detail">{{ ev.details || "" }}</span>
        <span class="by">by {{ ev.by }}</span>
      </li>
    </ul>
    <button class="secondary small" (click)="viewHistory()">
      <mat-icon>history</mat-icon> View Full History
    </button>
  </section>

  <!-- Actions -->
  <footer class="actions" *ngIf="!isPrintMode">
    <button
      class="primary"
      *ngIf="claim.status === 'Rejected' && !editMode"
      (click)="enableEdit()"
    >
      <mat-icon>edit</mat-icon> Edit Claim
    </button>

    <button class="primary" *ngIf="editMode" (click)="saveChanges()">
      <mat-icon>save</mat-icon> Save
    </button>

    <button class="accent" *ngIf="editMode" (click)="saveAndResubmit()">
      <mat-icon>send</mat-icon> Save & Resubmit
    </button>

    <button class="secondary" *ngIf="editMode" (click)="cancelEdit()">
      <mat-icon>close</mat-icon> Cancel
    </button>

    <button
      class="danger"
      *ngIf="claim.status !== 'Void'"
      (click)="withdrawClaim()"
    >
      <mat-icon>cancel</mat-icon> Withdraw Claim
    </button>

    <button class="secondary" routerLink="/dashboard-employee/claims">
      <mat-icon>arrow_back</mat-icon> Back to Claims
    </button>

    <button class="secondary" (click)="downloadClaim('pdf')">
      <mat-icon>download</mat-icon> Download PDF
    </button>

    <button class="secondary" (click)="downloadClaim('csv')">
      <mat-icon>download</mat-icon> Download CSV
    </button>

    <button class="secondary" (click)="printClaim()">
      <mat-icon>print</mat-icon> Print Claim
    </button>

    <button class="secondary" (click)="viewHistory()">
      <mat-icon>history</mat-icon> View Full History
    </button>
  </footer>
</div>
